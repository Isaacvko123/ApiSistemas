<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>usuarios - Operación Técnica</title>
    <style>
      :root {
        --bg:#f4f6f8;
        --ink:#0f172a;
        --muted:#475569;
        --card:#ffffff;
        --accent:#0b3a5b;
        --line:#e2e8f0;
        --shadow: 0 14px 30px rgba(2,6,23,0.08);
      }
      * { box-sizing: border-box; }
      body {
        margin:0;
        font-family: "Manrope", "Inter", "Segoe UI", sans-serif;
        background:
          radial-gradient(900px 500px at 15% -10%, rgba(14,165,233,0.10), transparent 60%),
          radial-gradient(900px 500px at 85% -5%, rgba(15,118,110,0.08), transparent 60%),
          var(--bg);
        color: var(--ink);
      }
      header {
        padding: 32px 40px 24px;
        border-bottom: 1px solid var(--line);
        background: #ffffff;
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 10;
      }
      h1 { margin: 0 0 6px; font-size: 30px; letter-spacing: -0.6px; font-weight: 800; }
      h2 { margin: 0 0 10px; font-size: 20px; font-weight: 700; }
      h3 { margin: 0 0 8px; font-size: 18px; font-weight: 700; }
      p { margin: 0; color: var(--muted); }
      main { padding: 28px 40px 48px; display: grid; gap: 16px; }
      .card { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 18px; box-shadow: var(--shadow); }
      .nav { display:flex; gap:12px; margin-top:10px; flex-wrap: wrap; }
      .nav a { color: var(--accent); text-decoration: none; font-weight: 700; padding: 8px 14px; border-radius: 999px; border: 1px solid var(--line); background: #f8fafc; }
      .nav a:hover { background:#e2e8f0; }
      .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
      .box { border:1px solid var(--line); background:#ffffff; padding:12px; border-radius:12px; }
      ul { margin: 8px 0 0; padding-left: 18px; color: var(--muted); }
      li { margin: 4px 0; }
      code { background:#f1f5f9; padding:2px 6px; border-radius:6px; }
      pre { background:#0f172a; color:#e2e8f0; padding:12px; border-radius:12px; overflow:auto; }
      table { width:100%; border-collapse: collapse; }
      th, td { text-align:left; padding:8px; border-bottom:1px solid var(--line); }
      th { color:#1e293b; font-weight:800; }
      .tag { display: inline-block; font-size: 12px; padding: 3px 10px; border-radius: 999px; background: #e2e8f0; color: #1e293b; border:1px solid #cbd5e1; font-weight: 700; }
      .role { font-weight:800; }
      @media (max-width: 720px) {
        header { padding: 22px 20px; }
        main { padding: 20px; }
        h1 { font-size: 24px; }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>usuarios</h1>
      <p>Controller, modelo, validaciones, DB y respuestas.</p>
      <div class="nav">
        <a href="/docs/operacion">Índice</a>
        <a href="/docs/portal">Inicio</a>
        <a href="/docs">Swagger</a>
      </div>
    </header>
    <main>
      <section class="card">
        <h2>Descripción</h2>
        <p>Gestión de usuarios, roles y estatus. Contraseñas se almacenan con hash Argon2 y nunca se exponen en respuestas.</p>
      </section>

      <section class="card">
        <h2>Relación visual rápida</h2>
        <svg viewBox="0 0 900 220" role="img" aria-label="Relaciones usuarios">
          <rect x="30" y="60" width="160" height="90" rx="14" fill="#0b3a5b"/>
          <text x="55" y="110" fill="#fff" font-size="16">USUARIO</text>

          <rect x="280" y="20" width="160" height="70" rx="12" fill="#0ea5e9"/>
          <text x="305" y="60" fill="#fff" font-size="14">SESION</text>

          <rect x="280" y="110" width="160" height="70" rx="12" fill="#0f766e"/>
          <text x="300" y="150" fill="#fff" font-size="14">AUDIT_LOG</text>

          <rect x="520" y="20" width="160" height="70" rx="12" fill="#0ea5e9"/>
          <text x="545" y="60" fill="#fff" font-size="14">RESGUARDO</text>

          <rect x="520" y="110" width="160" height="70" rx="12" fill="#0f766e"/>
          <text x="545" y="150" fill="#fff" font-size="14">DOCUMENTO</text>

          <path d="M190 105 L280 55" stroke="#0f172a" stroke-width="2"/>
          <path d="M190 105 L280 145" stroke="#0f172a" stroke-width="2"/>
          <path d="M440 55 L520 55" stroke="#0f172a" stroke-width="2"/>
          <path d="M440 145 L520 145" stroke="#0f172a" stroke-width="2"/>

          <text x="210" y="48" fill="#475569" font-size="12">1..*</text>
          <text x="210" y="168" fill="#475569" font-size="12">1..*</text>
          <text x="465" y="48" fill="#475569" font-size="12">1..*</text>
          <text x="465" y="168" fill="#475569" font-size="12">1..*</text>
        </svg>
      </section>

      <section class="card">
        <h2>Campos clave</h2>
        <div class="grid">
          <div class="box">
            <div class="tag">Obligatorios</div>
            <ul>
              <li><code>nombre</code> (2-100)</li>
              <li><code>email</code> (único)</li>
              <li><code>contrasena</code> (10-200, hash Argon2)</li>
              <li><code>rol</code> (ADMIN | GERENTE | SUPERVISOR)</li>
            </ul>
          </div>
          <div class="box">
            <div class="tag">Sistema</div>
            <ul>
              <li><code>activo</code> (boolean)</li>
              <li><code>tokenVersion</code> (control de sesiones)</li>
              <li><code>createdAt</code>, <code>updatedAt</code></li>
            </ul>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Rutas y permisos</h2>
        <table>
          <thead>
            <tr><th>Ruta</th><th>Rol</th><th>Notas</th></tr>
          </thead>
          <tbody>
            <tr><td><code>POST /usuarios</code></td><td class="role">Bootstrap / ADMIN / GERENTE</td><td>Solo público si no hay usuarios.</td></tr>
            <tr><td><code>GET /usuarios</code></td><td class="role">Autenticado</td><td>Filtros <code>?activo</code>, <code>?rol</code>.</td></tr>
            <tr><td><code>GET /usuarios/:id</code></td><td class="role">Autenticado</td><td>Valida id.</td></tr>
            <tr><td><code>PATCH /usuarios/:id</code></td><td class="role">ADMIN / GERENTE</td><td>Actualiza campos.</td></tr>
            <tr><td><code>DELETE /usuarios/:id</code></td><td class="role">ADMIN / GERENTE</td><td>Soft delete (<code>activo=false</code>).</td></tr>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2>Controller (UsuarioController)</h2>
        <div class="grid">
          <div class="box">
            <h3>listar</h3>
            <ul>
              <li>Filtros: <code>?activo=true/false</code>, <code>?rol=ADMIN|GERENTE|SUPERVISOR</code>.</li>
              <li>Orden: <code>id DESC</code>.</li>
              <li>Respuesta: usuarios públicos (sin contraseña/tokenVersion).</li>
            </ul>
          </div>
          <div class="box">
            <h3>obtener</h3>
            <ul>
              <li>Valida <code>id</code> numérico.</li>
              <li>404 si no existe.</li>
            </ul>
          </div>
          <div class="box">
            <h3>crear</h3>
            <ul>
              <li>Valida payload con Zod.</li>
              <li>Verifica email único.</li>
              <li>Hashea contraseña (Argon2).</li>
              <li>Auditoría: <code>USUARIO_CREATE</code>.</li>
            </ul>
          </div>
          <div class="box">
            <h3>actualizar</h3>
            <ul>
              <li>Valida payload (todo opcional).</li>
              <li>Si incluye contraseña: se hashea.</li>
              <li>Auditoría: <code>USUARIO_UPDATE</code>.</li>
            </ul>
          </div>
          <div class="box">
            <h3>desactivar</h3>
            <ul>
              <li>Soft-delete: <code>activo=false</code>.</li>
              <li>Auditoría: <code>USUARIO_DELETE</code>.</li>
            </ul>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Modelo / Validaciones (UsuarioModel)</h2>
        <ul>
          <li><code>usuarioCreateSchema</code>: nombre, email, contrasena, rol (default SUPERVISOR).</li>
          <li><code>usuarioUpdateSchema</code>: campos opcionales + <code>activo</code>.</li>
          <li><code>toUsuarioPublic</code>: elimina <code>contrasena</code> y <code>tokenVersion</code>.</li>
          <li><code>toUsuarioCreateData</code>: parsea Zod y hashea contraseña.</li>
          <li><code>toUsuarioUpdateData</code>: hashea si viene contrasena.</li>
        </ul>
      </section>

      <section class="card">
        <h2>Ejemplos (requests / responses)</h2>
        <div class="grid">
          <div class="box">
            <div class="tag">POST /usuarios</div>
            <pre>{
  "nombre": "Ana Pérez",
  "email": "ana@empresa.com",
  "contrasena": "MiPasswordSegura123",
  "rol": "SUPERVISOR"
}</pre>
          </div>
          <div class="box">
            <div class="tag">201 OK</div>
            <pre>{
  "id": 1,
  "nombre": "Ana Pérez",
  "email": "ana@empresa.com",
  "rol": "SUPERVISOR",
  "activo": true,
  "createdAt": "2026-02-05T12:00:00.000Z",
  "updatedAt": "2026-02-05T12:00:00.000Z"
}</pre>
          </div>
          <div class="box">
            <div class="tag">PATCH /usuarios/:id</div>
            <pre>{
  "rol": "GERENTE",
  "activo": true
}</pre>
          </div>
          <div class="box">
            <div class="tag">GET /usuarios?rol=GERENTE</div>
            <pre>[{
  "id": 2,
  "nombre": "Carlos Ruiz",
  "email": "carlos@empresa.com",
  "rol": "GERENTE",
  "activo": true
}]</pre>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Errores comunes (tabla)</h2>
        <table>
          <thead>
            <tr><th>HTTP</th><th>Causa</th><th>Solución</th></tr>
          </thead>
          <tbody>
            <tr><td>400</td><td>Payload inválido</td><td>Revisar campos y tipos.</td></tr>
            <tr><td>404</td><td>Usuario no encontrado</td><td>Validar <code>id</code>.</td></tr>
            <tr><td>409</td><td>Email duplicado</td><td>Usar email único.</td></tr>
            <tr><td>403</td><td>Rol sin permisos</td><td>Requiere ADMIN/GERENTE.</td></tr>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2>Checklist operativo</h2>
        <ul>
          <li>Verificar token válido.</li>
          <li>Validar rol del operador.</li>
          <li>Revisar duplicados (email).</li>
          <li>Registrar auditoría si se crea/actualiza.</li>
        </ul>
      </section>
    </main>
  </body>
</html>
